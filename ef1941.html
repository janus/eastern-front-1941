<html>
    <head>
        <style>
body {
    background-color: #999;
}
#screen {
    width: 320px;
    height: 192px;
    background-color: blue;
    transform-origin: top left;
    transform:  scale(4);
}
.section {
    width: 100%;
    overflow: hidden;
    position: relative;
}
.rule {
    height: 2px;
}
#date-window {
    height:  16px;
}
#date-window .row {
    transform-origin: top left;
    transform:  scale(2);
}
#map-window {
    height: 144px;
    overflow: scroll;
}
#info-window {
    height:  16px;
}
#err-window {
    height: 8px;
}
#map {
    /* 48 x 41  8px sq cells*/
    width: 384px;
    height: 328px;
    transform-origin: top left;
    transform: scale(1);
}
#unit-overlay {
    position: absolute;
    bottom: 8px;
    right: 8px;
}
@keyframes pulse {
  0% {-webkit-transform: scale(1.0); }
  100% {-webkit-transform: scale(1.2); }
}
.pulse {
  /* Giving Animation Function */
    animation: pulse 1s ease-out infinite;
}
.row {
    white-space: nowrap;
    background-color: #333;
}
.row-abs {
    position: absolute;
}
.chr {
    display: inline-block;
    width: 8px;
    height: 8px;
    /* via base64 fontmap.png */
    -webkit-mask-image: url(data:image/png;base64,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);
    -webkit-mask-size: 128px 128px;
    image-rendering: pixelated;
    color: #999; /* debugging */
    background-color:  white;
}
        </style>
    </head>
    <body>
        <script src="https://unpkg.com/d3@7.6.1/dist/d3.min.js"></script>
        <script type="text/javascript">
const
    // Antic NTSC palette via https://en.wikipedia.org/wiki/List_of_video_game_console_palettes#NTSC
    // 128 colors indexed via high 7 bits, e.g. 0x00 and 0x01 refer to the first entry
    colormap = ["#000000",  "#404040",  "#6c6c6c",  "#909090",  "#b0b0b0",  "#c8c8c8",  "#dcdcdc",  "#ececec",  "#444400",  "#646410",  "#848424",  "#a0a034",  "#b8b840",  "#d0d050",  "#e8e85c",  "#fcfc68",  "#702800",  "#844414",  "#985c28",  "#ac783c",  "#bc8c4c",  "#cca05c",  "#dcb468",  "#ecc878",  "#841800",  "#983418",  "#ac5030",  "#c06848",  "#d0805c",  "#e09470",  "#eca880",  "#fcbc94",  "#880000",  "#9c2020",  "#b03c3c",  "#c05858",  "#d07070",  "#e08888",  "#eca0a0",  "#fcb4b4",  "#78005c",  "#8c2074",  "#a03c88",  "#b0589c",  "#c070b0",  "#d084c0",  "#dc9cd0",  "#ecb0e0",  "#480078",  "#602090",  "#783ca4",  "#8c58b8",  "#a070cc",  "#b484dc",  "#c49cec",  "#d4b0fc",  "#140084",  "#302098",  "#4c3cac",  "#6858c0",  "#7c70d0",  "#9488e0",  "#a8a0ec",  "#bcb4fc",  "#000088",  "#1c209c",  "#3840b0",  "#505cc0",  "#6874d0",  "#7c8ce0",  "#90a4ec",  "#a4b8fc",  "#00187c",  "#1c3890",  "#3854a8",  "#5070bc",  "#6888cc",  "#7c9cdc",  "#90b4ec",  "#a4c8fc",  "#002c5c",  "#1c4c78",  "#386890",  "#5084ac",  "#689cc0",  "#7cb4d4",  "#90cce8",  "#a4e0fc",  "#003c2c",  "#1c5c48",  "#387c64",  "#509c80",  "#68b494",  "#7cd0ac",  "#90e4c0",  "#a4fcd4",  "#003c00",  "#205c20",  "#407c40",  "#5c9c5c",  "#74b474",  "#8cd08c",  "#a4e4a4",  "#b8fcb8",  "#143800",  "#345c1c",  "#507c38",  "#6c9850",  "#84b468",  "#9ccc7c",  "#b4e490",  "#c8fca4",  "#2c3000",  "#4c501c",  "#687034",  "#848c4c",  "#9ca864",  "#b4c078",  "#ccd488",  "#e0ec9c",  "#442800",  "#644818",  "#846830",  "#a08444",  "#b89c58",  "#d0b46c",  "#e8cc7c",  "#fce08c"],
    fontmap = (
' @*!%^&?????????????????????????????????????????????????????????' +
'???????0123??????????????????????????????????????????????????xo#' +
'???????????,.;:|/+-=_[]{}()<>abcdefghijklmnpqrstuvwyzABCDEFGH??~' +
'?????????????????????????????????????????????????????????????XO?'
    ),
    // Map with border is 48 x 41, coords 0-45 x 0-38 from bottom right excl boder
    mapdata = `
################################################
#~~~m        z~~n                              #
#~~~tw   ABDCByGu                              #
#~~~~tDCE~~vu0a<                               #
#~~~~~vqrsGHh;_.        ai >dfj                #
#~~~~~p   Fw}:[@^       _+e)  -ci    >h        #
#~~~~~n   zn=.]*&       {      >l1 ae(+di      #
#~~~~~tw   u[,{!@              [+dc<   2-j     #
#~~~~~~m      }%!             a)         [     #
#~~vq~~n1     _ *       *     ]          /fck  #
#~~n yrHcdi             @     {            >(  #
#~~m      |h     a<   2   3  >(            [   #
#~~p       /ej  >)     !&    }             =   #
#~~tw        +fg(   *{%@*bgec<             ]   #
#~~~n              >f( !%_                >)   #
#~~vHdceh   *&^  ag)0 @& =  }             {3   #
#~vu    +f @%!@ b<          {             _    #
#ru        *&3 .],          |fk          b<    #
#        @!^   :/i;      0    ]2         }     #
#       *&    ;,:-k           +i         ]     #
#j2     ^%  ,.:;. }            [         [     #
#-i     !@  ;cgi:,_       ]    /eh       {     #
# |k   !%& ,.:;+dj{       +j     -j      _     #
#  [   *^,:;,.,:.-l        {      |gcedj }     #
# >)     .,;:.   ,_       3_           =0|cdfi #
#({       :      0[        /i          [     /j#
#@&               |>e       -><a)>d    _      -#
#*^!%               +<b           +ab }]       #
#  @^&!  >e   >c      /)d          (f<{        #
#    %!@^ +c   -ab      -ac       }{           #
#     *%&  |<>)d |)e      |b     (]            #
#      @!^     /b  +d     1=   uiH2            #
#       *&%     -e  /c    (] vjnws             #
#        ^@& d   |c  -b   [ tp~yr              #
#        @*%!/e   +d2 =  }{ h~~lz              #
#        ^!&*@|c   -FiGjkHBq~~~ws 3})a>c       #
#  %^@^*!&@%^&*+b  un~~~wrCDDEgA(a<]   _       #
#  ^!&%@%* !%@& -Fkp~~~~lz  un~mGjkz           #
#               vq~~~~~~~mAtp~~~~~~miA^%*!&@&*@#
#               h~~~~~~~~~lq~~~~~~~~~ljkA@*!%!!#
################################################
`
        .split(/\n/).slice(1,-1),
    oob = [
        // [CORPSX, CORPSY, MSTRNG, SWAP, ARRIVE, CORPT, CORPNO
        // German
        [0, 0, 0, 0, 255, 0, 0],
        [40, 20, 203, 126, 0, 3, 24],
        [40, 19, 205, 126, 255, 3, 39],
        [40, 18, 192, 126, 0, 3, 46],
        [40, 17, 199, 126, 0, 3, 47],
        [40, 16, 184, 126, 0, 3, 57],
        [41, 20, 136, 125, 0, 0, 5],
        [40, 19, 127, 125, 0, 0, 6],
        [41, 18, 150, 125, 0, 0, 7],
        [41, 17, 129, 125, 0, 0, 8],
        [41, 16, 136, 125, 0, 0, 9],
        [42, 20, 109, 125, 255, 0, 12],
        [42, 19, 72, 125, 255, 0, 13],
        [42, 18, 70, 125, 255, 0, 20],
        [42, 17, 81, 125, 255, 0, 42],
        [43, 19, 131, 125, 255, 0, 43],
        [43, 18, 102, 125, 255, 0, 53],
        [43, 17, 53, 125, 255, 64, 3],
        [41, 23, 198, 126, 0, 3, 41],
        [40, 22, 194, 126, 0, 3, 56],
        [40, 21, 129, 125, 0, 0, 1],
        [41, 21, 123, 125, 0, 0, 2],
        [41, 22, 101, 125, 0, 0, 10],
        [42, 22, 104, 125, 0, 0, 26],
        [42, 23, 112, 125, 0, 0, 28],
        [42, 24, 120, 125, 0, 0, 38],
        [40, 15, 202, 126, 0, 3, 3],
        [41, 14, 195, 126, 0, 3, 14],
        [42, 13, 191, 126, 0, 3, 48],
        [41, 15, 72, 126, 255, 3, 52],
        [42, 14, 140, 125, 0, 0, 49],
        [42, 12, 142, 125, 0, 0, 4],
        [43, 13, 119, 125, 0, 0, 17],
        [41, 15, 111, 125, 0, 0, 29],
        [42, 16, 122, 125, 255, 0, 44],
        [43, 16, 77, 125, 255, 0, 55],
        [30, 2, 97, 125, 0, 48, 1],
        [30, 3, 96, 125, 0, 48, 2],
        [31, 4, 92, 125, 0, 48, 4],
        [33, 6, 125, 125, 0, 0, 11],
        [35, 7, 131, 125, 0, 0, 30],
        [37, 8, 106, 125, 0, 0, 54],
        [35, 38, 112, 125, 0, 32, 2],
        [36, 37, 104, 125, 0, 32, 4],
        [36, 38, 101, 125, 255, 32, 6],
        [45, 20, 210, 126, 2, 3, 40],
        [45, 15, 97, 125, 255, 0, 27],
        [38, 8, 98, 126, 2, 83, 1],
        [45, 16, 95, 125, 5, 0, 23],
        [31, 1, 52, 125, 6, 48, 5],
        [45, 20, 98, 125, 9, 0, 34],
        [45, 19, 96, 125, 10, 0, 35],
        [32, 1, 55, 125, 11, 64, 4],
        [45, 17, 104, 125, 20, 0, 51],
        [45, 18, 101, 126, 24, 7, 50],
        // Russian
        [29, 32, 100, 253, 4, 4, 7],
        [27, 31, 103, 253, 5, 4, 11],
        [24, 38, 110, 253, 7, 0, 41],
        [23, 38, 101, 253, 9, 0, 42],
        [20, 38, 92, 253, 11, 0, 43],
        [15, 38, 103, 253, 13, 0, 44],
        [0, 20, 105, 253, 7, 0, 45],
        [0, 8, 107, 253, 12, 0, 46],
        [0, 18, 111, 253, 8, 0, 47],
        [0, 10, 88, 253, 10, 0, 48],
        [0, 14, 117, 254, 10, 1, 9],
        [0, 33, 84, 254, 14, 1, 13],
        [0, 11, 109, 254, 15, 1, 14],
        [0, 15, 89, 254, 16, 1, 15],
        [0, 20, 105, 254, 18, 1, 16],
        [0, 10, 93, 254, 7, 2, 7],
        [21, 28, 62, 254, 0, 1, 2],
        [21, 27, 104, 253, 0, 0, 19],
        [30, 14, 101, 253, 0, 0, 18],
        [30, 13, 67, 254, 0, 2, 1],
        [39, 28, 104, 253, 0, 0, 27],
        [38, 28, 84, 254, 0, 1, 10],
        [23, 31, 127, 253, 0, 0, 22],
        [19, 24, 112, 253, 0, 0, 21],
        [34, 22, 111, 253, 0, 0, 13],
        [34, 21, 91, 254, 0, 1, 6],
        [31, 34, 79, 253, 0, 4, 9],
        [27, 6, 69, 253, 0, 0, 2],
        [33, 37, 108, 253, 0, 4, 1],
        [41, 24, 118, 253, 0, 0, 8],
        [40, 23, 137, 253, 0, 0, 11],
        [39, 23, 70, 254, 0, 1, 1],
        [42, 25, 85, 254, 0, 1, 7],
        [39, 20, 130, 253, 0, 0, 3],
        [39, 22, 91, 253, 0, 0, 4],
        [39, 18, 131, 253, 0, 0, 10],
        [39, 17, 71, 254, 0, 1, 5],
        [39, 21, 86, 254, 0, 1, 8],
        [37, 20, 75, 254, 0, 2, 3],
        [39, 19, 90, 254, 0, 2, 6],
        [39, 16, 123, 253, 0, 0, 5],
        [39, 15, 124, 253, 0, 0, 6],
        [40, 14, 151, 253, 0, 0, 12],
        [41, 13, 128, 253, 0, 0, 26],
        [41, 12, 88, 254, 0, 1, 3],
        [39, 11, 77, 254, 0, 1, 4],
        [36, 9, 79, 254, 0, 1, 11],
        [34, 8, 80, 254, 0, 2, 5],
        [32, 6, 126, 253, 0, 0, 9],
        [35, 9, 79, 254, 0, 1, 12],
        [30, 4, 91, 254, 0, 2, 4],
        [28, 2, 84, 254, 0, 2, 2],
        [25, 6, 72, 253, 1, 0, 7],
        [29, 14, 86, 253, 1, 4, 2],
        [32, 22, 76, 253, 1, 0, 14],
        [33, 36, 99, 253, 1, 4, 4],
        [26, 23, 67, 253, 1, 0, 15],
        [21, 8, 78, 253, 2, 0, 16],
        [29, 33, 121, 253, 2, 0, 20],
        [0, 28, 114, 253, 2, 0, 6],
        [28, 30, 105, 253, 3, 0, 24],
        [21, 20, 122, 253, 3, 0, 40],
        [21, 28, 127, 253, 4, 0, 29],
        [21, 33, 129, 253, 4, 0, 30],
        [20, 27, 105, 253, 5, 0, 31],
        [20, 30, 111, 253, 5, 0, 32],
        [12, 8, 112, 253, 6, 0, 33],
        [0, 10, 127, 253, 6, 0, 37],
        [0, 32, 119, 253, 7, 0, 43],
        [0, 11, 89, 253, 8, 0, 49],
        [0, 25, 108, 253, 8, 0, 50],
        [0, 12, 113, 253, 8, 0, 52],
        [0, 23, 105, 253, 9, 0, 54],
        [0, 13, 94, 253, 9, 0, 55],
        [21, 29, 103, 254, 5, 114, 1],
        [25, 30, 97, 253, 5, 0, 34],
        [0, 31, 108, 253, 2, 112, 1],
        [0, 15, 110, 253, 9, 112, 2],
        [0, 27, 111, 253, 10, 112, 3],
        [0, 17, 96, 253, 10, 112, 4],
        [0, 25, 109, 253, 6, 0, 39],
        [0, 11, 112, 253, 11, 0, 59],
        [0, 23, 95, 253, 5, 0, 60],
        [0, 19, 93, 253, 17, 0, 61],
        [0, 21, 114, 254, 2, 114, 2],
        [0, 33, 103, 254, 11, 1, 1],
        [0, 28, 107, 254, 20, 113, 1],
        [0, 13, 105, 253, 21, 112, 5],
        [0, 26, 92, 254, 22, 1, 2],
        [0, 10, 109, 253, 23, 112, 6],
        [0, 29, 101, 254, 24, 1, 3],
        [0, 35, 106, 254, 26, 1, 4],
        [0, 27, 95, 253, 28, 0, 38],
        [0, 15, 99, 254, 30, 0, 36],
        [38, 30, 101, 253, 2, 0, 35],
        [21, 22, 118, 253, 3, 0, 28],
        [12, 8, 106, 253, 3, 0, 25],
        [20, 13, 112, 253, 3, 0, 23],
        [21, 14, 104, 253, 3, 0, 17],
        [20, 28, 185, 253, 6, 4, 8],
        [15, 3, 108, 253, 6, 4, 10],
        [21, 3, 94, 253, 4, 4, 3],
        [20, 3, 102, 253, 4, 4, 5],
        [19, 2, 98, 253, 4, 4, 6],
    ].map((vs, i) => {
        let u = {
            PLAYER: i < 54 ? 0: 1,
            X: vs[0], Y: vs[1],
            MSTRNG: vs[2], CSTRNG: vs[2],
            ICON: vs[3],
            ARRIVE: vs[4],
            TYP: vs[5],
            ID: vs[6],
        }
        u.LABEL = [
            u.ID,
            ['', 'SS', 'FINNISH', 'RUMANIAN', 'ITALIAN', 'HUNGARAN', 'MOUNTAIN', 'GUARDS']
            [u.TYP >> 4],
            ['INFANTRY', 'TANK', 'CAVALRY', 'PANZER', 'MILITIA', 'SHOCK', 'PARATRP', 'PZRGRNDR']
            [u.TYP & 0x0f],
            ['CORPS', 'ARMY'][u.PLAYER]
        ].filter(Boolean).join(' ').trim();
        return u;
    });
    </script>

    <div id="screen">
        <div id="date-window" class="section"></div>
        <div class="date-rule rule section"></div>
        <div id="map-window" class="section">
            <div id="map">
                <div id="terrain"></div>
                <div id="unit-overlay"></div>
            </div>
        </div>
        <div class="info-rule rule section"></div>
        <div id="info-window" class="section"></div>
        <div class="err-rule rule section"></div>
        <div id="err-window" class="section"></div>
        <div class="err-rule rule section"></div>
        </div>
    </div>

    <script type="text/javascript">
function hexcolor(v) {
    if (typeof v === 'string') v = parseInt(v, 16);
    return colormap[Math.floor(v/2)];
}

function atasciichrclr(c) {
    let x = c.charCodeAt(0) % 128,
        chr = (x >= 32 && x < 96) ? x - 32 : (x < 32 ? x + 48: x),
        clr = 0; //TODO
    return [chr, clr];
}

function putchrs(win, data, chrclr, idfn, rowcol) {
    if (!chrclr) chrclr = atasciichrclr;
    if (!idfn) idfn = (d, i) => i;

    let rowidx = (d, i) => rowcol ? rowcol(d[0], i)[0] : i,
        lines = rowcol ? data.map(d => [d]): data,
        rows = d3.select(win)
        .selectAll('div.row')
        .data(lines, d => idfn(d[0]))
      .join('div')
        .attr('class', 'row')
        .attr('data-row-index', rowidx);

    if (rowcol) {
        rows.classed('row-abs', true)
            .each(function(d, i) {
                let [row, col] = rowcol(d[0], i);
                d3.select(this)
                    .style('right', `${col*8}px`)
                    .style('bottom', `${row*8}px`)
            })
    }
    rows.selectAll('div.chr')
        .data(d => d)
      .join('div')
        .datum(chrclr)
        .attr('class', ([_, clr]) => 'chr fgclr-' + clr)
        .style("-webkit-mask-position", ([chr, _]) => `${-(chr%16)*8}px ${-Math.floor(chr/16)*8}px`)
        ;
}


putchrs('#date-window', ['June 22, 1941'])
putchrs('#info-window', ['EASTERN FRONT 1941', 'COPYRIGHT 1981 CHRIS CRAWFORD'])
putchrs('#err-window', ['PLEASE ENTER YOUR ORDERS NOW'])

function mapchrclr(d) {
    const c = fontmap.indexOf(d),
        clr = c >> 6,
        chr = (c & 0x3f) + 0x40 * (this.parentNode.dataset.rowIndex <= 24 ? 2: 3);
    return [chr, clr];
}
putchrs('#terrain', mapdata, mapchrclr);


putchrs(
    '#unit-overlay',
    oob.filter(u => u.ARRIVE == 0),
    u => [u.ICON & 0x3f | 0x80, u.ICON >> 6],
    u => u.LABEL,
    u => [u.Y, u.X]
);


//TODO - debug colors
let colors = ['B0', '6A', '0C', '94', '46', '1A', '28', '22', '8A', '00', '3A', 'D4'];
d3.select('#screen')
    .append('div')
    .selectAll('span')
    .data(colors)
  .join('span')
    .style('background-color', hexcolor)
    .style('color', '#666')
    .text(d => d);

/*
Colors PDF p67

Section         BK      0       1       2       3
vert blank      B0      6A      OC      94      46
date window     1A      TRCOLR
date hrule      EARTH
map north               28
unit hrule                              22
unit info       8A
err hrule                       00      3A
err message     D4
*/

// tree color by month EFT18D.ASM
// TRTAB    0,$12,$12,$12,$D2,$D8,$D6,$C4,$D4,$C2,$12,$12,$12

// in some character modes COL2 is the background instead of COLBK

d3.selectAll('#unit-overlay .chr').classed('pulse', true);

var map = d3.select('#map')

map.selectAll('.row').style('background-color', hexcolor('02'));
map.selectAll('.fgclr-0').style('background-color', hexcolor('D6'));
map.selectAll('.row:nth-child(n+25) .fgclr-0').style('background-color', hexcolor('28'));
map.selectAll('.fgclr-1').style('background-color', hexcolor('0C'));
map.selectAll('.fgclr-2').style('background-color', hexcolor('94'));
map.selectAll('.fgclr-3').style('background-color', hexcolor('46'));

// TODO map south should have fgclr-0 => 28

d3.selectAll('#date-window .row').style('background-color', hexcolor('B0'));
d3.selectAll('#date-window .fgclr-0').style('background-color', hexcolor('6A'));
d3.selectAll('.date-rule').style('background-color', hexcolor('1A'));

d3.selectAll('.info-rule').style('background-color', hexcolor('02'));  // same as map
d3.selectAll('#info-window .row').style('background-color', hexcolor('22'));
d3.selectAll('#info-window .fgclr-0').style('background-color', hexcolor('28'));
d3.selectAll('#info-window .fgclr-2').style('background-color', hexcolor('28'));

d3.selectAll('.err-rule').style('background-color', hexcolor('8A'));
d3.selectAll('#err-window .row').style('background-color', hexcolor('3A'));
d3.selectAll('#err-window .fgclr-1').style('background-color', hexcolor('00'));
d3.selectAll('#err-window .fgclr-2').style('background-color', hexcolor('3A'));

        </script>
    </body>
</html>
