<html>
<head>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <script src="https://unpkg.com/d3@7.6.1/dist/d3.min.js"></script>
    <script src="/static/data.js"></script>

    <div id="screen">
        <div id="date-window" class="section"></div>
        <div class="date-rule rule section"></div>
        <div id="map-window" class="section">
            <div id="map">
                <div id="terrain"></div>
                <div id="kreuze-overlay"></div>
                <div id="unit-overlay"></div>
            </div>
        </div>
        <div class="info-rule rule section"></div>
        <div id="info-window" class="section"></div>
        <div class="err-rule rule section"></div>
        <div id="err-window" class="section"></div>
        <div class="err-rule rule section"></div>
        </div>
    </div>

    <script type="text/javascript">
function hexcolor(v) {
    return colormap[Math.floor(parseInt(v, 16)/2)];
}

function setclr(sel, c) {
    d3.selectAll(sel).style('background-color', hexcolor(c));
}

function atascii(c) {
    let x = c.charCodeAt(0) % 128;
    return (x >= 32 && x < 96) ? x - 32 : (x < 32 ? x + 48: x);
}

function zc(k) {
    // https://en.wikipedia.org/wiki/Z-order_curve
    const z16 = [
        0b00000000, 0b00000001, 0b00000100, 0b00000101,
        0b00010000, 0b00010001, 0b00010100, 0b00010101,
        0b01000000, 0b01000001, 0b00000100, 0b00000101,
        0b01010000, 0b01010001, 0b01010100, 0b01010101,
    ];
    let v = z16[k & 0xf];
    if (k > 16) v += zc(k>>4)<<8;
    return v;
}

function zcurve(i, j) {
    return (zc(i) << 1) | zc(j);
}

function putchrs(win, data, fg, bg, chrfn, idfn, rowcol) {
    if (!chrfn) chrfn = atascii;
    if (!idfn) idfn = (d, i) => i;
    fgfn = typeof fg == 'function' ? fg : (_ => fg);
    bgfn = typeof bg == 'function' ? bg : (_ => bg);

    let rowidx = (d, i) => rowcol ? rowcol(d[0], i)[0] : i,
        lines = rowcol ? data.map(d => [d]): data,
        rows = d3.select(win)
        .selectAll('div.row')
        .data(lines, d => idfn(d[0]))
      .join('div')
        .attr('class', 'row')
        .attr('data-row-index', rowidx)
        .style('background-color', d => hexcolor(bgfn(d)));

    if (rowcol) {
        rows.classed('row-abs', true)
            .each(function(d, i) {
                let [row, col] = rowcol(d[0], i);
                d3.select(this)
                    .style('right', `${col*8}px`)
                    .style('bottom', `${row*8}px`)
            })
    }
    return rows.selectAll('div.chr')
        .data(d => d)
      .join('div')
        .classed('chr', true)
        .style('background-color', d => hexcolor(fgfn(d)))
        .style("-webkit-mask-position", d => {
            let c = chrfn(d);
            return `${-(c%16)*8}px ${-Math.floor(c/16)*8}px`
        });
}

setclr('body', 'D4')
setclr('.date-rule', '1A');
setclr('.info-rule', '02');  // same as map
setclr('.err-rule', '8A');

putchrs('#date-window', ['June 22, 1941'], '6A', 'B0')
putchrs('#info-window', ['EASTERN FRONT 1941', 'COPYRIGHT 1981 CHRIS CRAWFORD'], '28', '22')
putchrs('#err-window', ['PLEASE ENTER YOUR ORDERS NOW'], '22', '3A')

putchrs(
    '#terrain',
    mapdata,
    ([c, t, alt]) => {
        let ter = terraintypes[t];
        return alt ? ter.altcolor : ter.color
    },
    '02',
    ([c, t, alt]) => c
);

var kreuze = {X: 30, Y: 18};

putchrs('#kreuze-overlay', [kreuze], '1A', '02', _ => 256, _ => 0, d => [d.Y, d.X]);

d3.select('#kreuze-overlay .chr').node().scrollIntoView({block: "center", inline: "center"});
// d3.select('#map .row:nth-child(19) .chr:nth-child(26)').style('background-color', 'yellow').node().scrollIntoView({block: "center", inline: "center"});

function unitclick(ev, u) {
    this.scrollIntoView({block: "center", inline: "center"});
    putchrs('#info-window', [u.LABEL, ' '], '28', '22')
    if (u.PLAYER == 0) {
        d3.select('.blink').classed('blink', false);
        current = german.findIndex(d => d.ID == u.ID);
        console.log(current);
        putchrs('#kreuze-overlay', [kreuze], '1A', '02', _ => 256, _ => 0, d => [u.Y, u.X]);
        d3.select(this.parentNode).classed('blink', true);
    }
}

var active = oob.filter(u => u.ARRIVE == 0),
    german = active.filter(u => u.PLAYER == 0)
        .sort((a, b) => zcurve(a.X, a.Y) - zcurve(b.X, b.Y)),
    current = null;

putchrs(
    '#unit-overlay',
    active,
    u => u.ICON & 0x80 ? '46' : '0C',
    '02',
    u => u.ICON & 0x3f | 0x80,
    u => u.LABEL,
    u => [u.Y, u.X]
).on('click', unitclick);




//TODO - debug colors
/*
let colors = ['B0', '6A', '0C', '94', '46', '1A', '28', '22', '8A', '00', '3A', 'D4'];
d3.select('#screen')
    .append('div')
    .selectAll('span')
    .data(colors)
  .join('span')
    .style('background-color', hexcolor)
    .style('color', '#666')
    .text(d => d);
*/
/*
Colors PDF p67

Section         BK      0       1       2       3
vert blank      B0      6A      OC      94      46
date window     1A      TRCOLR
date hrule      EARTH
map north               28
unit hrule                              22
unit info       8A
err hrule                       00      3A
err message     D4
*/

// tree color by month EFT18D.ASM
// TRTAB    0,$12,$12,$12,$D2,$D8,$D6,$C4,$D4,$C2,$12,$12,$12

// in some character modes COL2 is the background instead of COLBK


var zoom = 1;
document.addEventListener('keydown', function (e) {
    console.log(e.key);
    if (e.key == 'z') {
        zoom = zoom == 1 ? 2: 1;
        d3.select('#map').style('transform', `scale(${zoom})`);
    }
//    e.preventDefault();
    //  ArrowRight Left Up Down, Enter, ' '
});

    </script>
</body>
</html>
