<html>
    <head>
        <style>
body {
    background-color: #999;
}
#screen {
    width: 320px;
    height: 192px;
    background-color: blue;
    transform-origin: top left;
    transform:  scale(4);
}
.section {
    width: 100%;
    overflow: hidden;
    position: relative;
}
.rule {
    height: 2px;
}
#date-window {
    height:  16px;
}
#date-window .row {
    transform-origin: top left;
    transform:  scale(2);
}
#map-window {
    height: 144px;
    overflow: scroll;
}
#info-window {
    height:  16px;
}
#err-window {
    height: 8px;
}
#map {
    /* 48 x 41  8px sq cells*/
    width: 384px;
    height: 328px;
    transform-origin: top left;
    transform: scale(1);
}
#unit-overlay {
    position: absolute;
    bottom: 8px;
    right: 8px;
}
@keyframes pulse {
  0% {-webkit-transform: scale(1.0); }
  100% {-webkit-transform: scale(1.2); }
}
@keyframes blink {
  0% {opacity: 1.0;}
  100% {opacity: 0.0;}
}
.pulse {
  /* Giving Animation Function */
    animation: pulse 1s ease-out infinite;
}
.blink {
    animation: blink 0.8s ease-in infinite;
}
.row {
    white-space: nowrap;
    background-color: #333;
}
.row-abs {
    position: absolute;
}
.chr {
    display: inline-block;
    width: 8px;
    height: 8px;
    /* via base64 fontmap.png */
    -webkit-mask-image: url(data:image/png;base64,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);
    -webkit-mask-size: 128px 136px;
    image-rendering: pixelated;
    color: #999; /* debugging */
    background-color:  white;
}
        </style>
    </head>
    <body>
        <script src="https://unpkg.com/d3@7.6.1/dist/d3.min.js"></script>
        <script type="text/javascript">
const
    // Antic NTSC palette via https://en.wikipedia.org/wiki/List_of_video_game_console_palettes#NTSC
    // 128 colors indexed via high 7 bits, e.g. 0x00 and 0x01 refer to the first entry
    colormap = ["#000000",  "#404040",  "#6c6c6c",  "#909090",  "#b0b0b0",  "#c8c8c8",  "#dcdcdc",  "#ececec",  "#444400",  "#646410",  "#848424",  "#a0a034",  "#b8b840",  "#d0d050",  "#e8e85c",  "#fcfc68",  "#702800",  "#844414",  "#985c28",  "#ac783c",  "#bc8c4c",  "#cca05c",  "#dcb468",  "#ecc878",  "#841800",  "#983418",  "#ac5030",  "#c06848",  "#d0805c",  "#e09470",  "#eca880",  "#fcbc94",  "#880000",  "#9c2020",  "#b03c3c",  "#c05858",  "#d07070",  "#e08888",  "#eca0a0",  "#fcb4b4",  "#78005c",  "#8c2074",  "#a03c88",  "#b0589c",  "#c070b0",  "#d084c0",  "#dc9cd0",  "#ecb0e0",  "#480078",  "#602090",  "#783ca4",  "#8c58b8",  "#a070cc",  "#b484dc",  "#c49cec",  "#d4b0fc",  "#140084",  "#302098",  "#4c3cac",  "#6858c0",  "#7c70d0",  "#9488e0",  "#a8a0ec",  "#bcb4fc",  "#000088",  "#1c209c",  "#3840b0",  "#505cc0",  "#6874d0",  "#7c8ce0",  "#90a4ec",  "#a4b8fc",  "#00187c",  "#1c3890",  "#3854a8",  "#5070bc",  "#6888cc",  "#7c9cdc",  "#90b4ec",  "#a4c8fc",  "#002c5c",  "#1c4c78",  "#386890",  "#5084ac",  "#689cc0",  "#7cb4d4",  "#90cce8",  "#a4e0fc",  "#003c2c",  "#1c5c48",  "#387c64",  "#509c80",  "#68b494",  "#7cd0ac",  "#90e4c0",  "#a4fcd4",  "#003c00",  "#205c20",  "#407c40",  "#5c9c5c",  "#74b474",  "#8cd08c",  "#a4e4a4",  "#b8fcb8",  "#143800",  "#345c1c",  "#507c38",  "#6c9850",  "#84b468",  "#9ccc7c",  "#b4e490",  "#c8fca4",  "#2c3000",  "#4c501c",  "#687034",  "#848c4c",  "#9ca864",  "#b4c078",  "#ccd488",  "#e0ec9c",  "#442800",  "#644818",  "#846830",  "#a08444",  "#b89c58",  "#d0b46c",  "#e8cc7c",  "#fce08c"],
    fontmap = (
' @*!%^&?????????????????????????????????????????????????????????' +
'???????0123??????????????????????????????????????????????????xo#' +
'???????????,.;:|/+-=_[]{}()<>abcdefghijklmnpqrstuvwyzABCDEFGH??~' +
'?????????????????????????????????????????????????????????????XO?'
    ),
    // Map with border is 48 x 41, coords 0-45 x 0-38 from bottom right excl boder
    mapdata = `
################################################
#~~~m        z~~n                              #
#~~~tw   ABDCByGu                              #
#~~~~tDCE~~vu0a<                               #
#~~~~~vqrsGHh;_.        ai >dfj                #
#~~~~~p   Fw}:[@^       _+e)  -ci    >h        #
#~~~~~n   zn=.]*&       {      >l1 ae(+di      #
#~~~~~tw   u[,{!@              [+dc<   2-j     #
#~~~~~~m      }%!             a)         [     #
#~~vq~~n1     _ *       *     ]          /fck  #
#~~n yrHcdi             @     {            >(  #
#~~m      |h     a<   2   3  >(            [   #
#~~p       /ej  >)     !&    }             =   #
#~~tw        +fg(   *{%@*bgec<             ]   #
#~~~n              >f( !%_                >)   #
#~~vHdceh   *&^  ag)0 @& =  }             {3   #
#~vu    +f @%!@ b<          {             _    #
#ru        *&3 .],          |fk          b<    #
#        @!^   :/i;      0    ]2         }     #
#       *&    ;,:-k           +i         ]     #
#j2     ^%  ,.:;. }            [         [     #
#-i     !@  ;cgi:,_       ]    /eh       {     #
# |k   !%& ,.:;+dj{       +j     -j      _     #
#  [   *^,:;,.,:.-l        {      |gcedj }     #
# >)     .,;:.   ,_       3_           =0|cdfi #
#({       :      0[        /i          [     /j#
#@&               |>e       -><a)>d    _      -#
#*^!%               +<b           +ab }]       #
#  @^&!  >e   >c      /)d          (f<{        #
#    %!@^ +c   -ab      -ac       }{           #
#     *%&  |<>)d |)e      |b     (]            #
#      @!^     /b  +d     1=   uiH2            #
#       *&%     -e  /c    (] vjnws             #
#        ^@& d   |c  -b   [ tp~yr              #
#        @*%!/e   +d2 =  }{ h~~lz              #
#        ^!&*@|c   -FiGjkHBq~~~ws 3})a>c       #
#  %^@^*!&@%^&*+b  un~~~wrCDDEgA(a<]   _       #
#  ^!&%@%* !%@& -Fkp~~~~lz  un~mGjkz           #
#               vq~~~~~~~mAtp~~~~~~miA^%*!&@&*@#
#               h~~~~~~~~~lq~~~~~~~~~ljkA@*!%!!#
################################################
`
        .split(/\n/).slice(1,-1),
    oob = [
        // [CORPSX, CORPSY, MSTRNG, SWAP, ARRIVE, CORPT, CORPNO
        // German
        [0, 0, 0, 0, 255, 0, 0],
        [40, 20, 203, 126, 0, 3, 24],
        [40, 19, 205, 126, 255, 3, 39],
        [40, 18, 192, 126, 0, 3, 46],
        [40, 17, 199, 126, 0, 3, 47],
        [40, 16, 184, 126, 0, 3, 57],
        [41, 20, 136, 125, 0, 0, 5],
        [40, 19, 127, 125, 0, 0, 6],
        [41, 18, 150, 125, 0, 0, 7],
        [41, 17, 129, 125, 0, 0, 8],
        [41, 16, 136, 125, 0, 0, 9],
        [42, 20, 109, 125, 255, 0, 12],
        [42, 19, 72, 125, 255, 0, 13],
        [42, 18, 70, 125, 255, 0, 20],
        [42, 17, 81, 125, 255, 0, 42],
        [43, 19, 131, 125, 255, 0, 43],
        [43, 18, 102, 125, 255, 0, 53],
        [43, 17, 53, 125, 255, 64, 3],
        [41, 23, 198, 126, 0, 3, 41],
        [40, 22, 194, 126, 0, 3, 56],
        [40, 21, 129, 125, 0, 0, 1],
        [41, 21, 123, 125, 0, 0, 2],
        [41, 22, 101, 125, 0, 0, 10],
        [42, 22, 104, 125, 0, 0, 26],
        [42, 23, 112, 125, 0, 0, 28],
        [42, 24, 120, 125, 0, 0, 38],
        [40, 15, 202, 126, 0, 3, 3],
        [41, 14, 195, 126, 0, 3, 14],
        [42, 13, 191, 126, 0, 3, 48],
        [41, 15, 72, 126, 255, 3, 52],
        [42, 14, 140, 125, 0, 0, 49],
        [42, 12, 142, 125, 0, 0, 4],
        [43, 13, 119, 125, 0, 0, 17],
        [41, 15, 111, 125, 0, 0, 29],
        [42, 16, 122, 125, 255, 0, 44],
        [43, 16, 77, 125, 255, 0, 55],
        [30, 2, 97, 125, 0, 48, 1],
        [30, 3, 96, 125, 0, 48, 2],
        [31, 4, 92, 125, 0, 48, 4],
        [33, 6, 125, 125, 0, 0, 11],
        [35, 7, 131, 125, 0, 0, 30],
        [37, 8, 106, 125, 0, 0, 54],
        [35, 38, 112, 125, 0, 32, 2],
        [36, 37, 104, 125, 0, 32, 4],
        [36, 38, 101, 125, 255, 32, 6],
        [45, 20, 210, 126, 2, 3, 40],
        [45, 15, 97, 125, 255, 0, 27],
        [38, 8, 98, 126, 2, 83, 1],
        [45, 16, 95, 125, 5, 0, 23],
        [31, 1, 52, 125, 6, 48, 5],
        [45, 20, 98, 125, 9, 0, 34],
        [45, 19, 96, 125, 10, 0, 35],
        [32, 1, 55, 125, 11, 64, 4],
        [45, 17, 104, 125, 20, 0, 51],
        [45, 18, 101, 126, 24, 7, 50],
        // Russian
        [29, 32, 100, 253, 4, 4, 7],
        [27, 31, 103, 253, 5, 4, 11],
        [24, 38, 110, 253, 7, 0, 41],
        [23, 38, 101, 253, 9, 0, 42],
        [20, 38, 92, 253, 11, 0, 43],
        [15, 38, 103, 253, 13, 0, 44],
        [0, 20, 105, 253, 7, 0, 45],
        [0, 8, 107, 253, 12, 0, 46],
        [0, 18, 111, 253, 8, 0, 47],
        [0, 10, 88, 253, 10, 0, 48],
        [0, 14, 117, 254, 10, 1, 9],
        [0, 33, 84, 254, 14, 1, 13],
        [0, 11, 109, 254, 15, 1, 14],
        [0, 15, 89, 254, 16, 1, 15],
        [0, 20, 105, 254, 18, 1, 16],
        [0, 10, 93, 254, 7, 2, 7],
        [21, 28, 62, 254, 0, 1, 2],
        [21, 27, 104, 253, 0, 0, 19],
        [30, 14, 101, 253, 0, 0, 18],
        [30, 13, 67, 254, 0, 2, 1],
        [39, 28, 104, 253, 0, 0, 27],
        [38, 28, 84, 254, 0, 1, 10],
        [23, 31, 127, 253, 0, 0, 22],
        [19, 24, 112, 253, 0, 0, 21],
        [34, 22, 111, 253, 0, 0, 13],
        [34, 21, 91, 254, 0, 1, 6],
        [31, 34, 79, 253, 0, 4, 9],
        [27, 6, 69, 253, 0, 0, 2],
        [33, 37, 108, 253, 0, 4, 1],
        [41, 24, 118, 253, 0, 0, 8],
        [40, 23, 137, 253, 0, 0, 11],
        [39, 23, 70, 254, 0, 1, 1],
        [42, 25, 85, 254, 0, 1, 7],
        [39, 20, 130, 253, 0, 0, 3],
        [39, 22, 91, 253, 0, 0, 4],
        [39, 18, 131, 253, 0, 0, 10],
        [39, 17, 71, 254, 0, 1, 5],
        [39, 21, 86, 254, 0, 1, 8],
        [37, 20, 75, 254, 0, 2, 3],
        [39, 19, 90, 254, 0, 2, 6],
        [39, 16, 123, 253, 0, 0, 5],
        [39, 15, 124, 253, 0, 0, 6],
        [40, 14, 151, 253, 0, 0, 12],
        [41, 13, 128, 253, 0, 0, 26],
        [41, 12, 88, 254, 0, 1, 3],
        [39, 11, 77, 254, 0, 1, 4],
        [36, 9, 79, 254, 0, 1, 11],
        [34, 8, 80, 254, 0, 2, 5],
        [32, 6, 126, 253, 0, 0, 9],
        [35, 9, 79, 254, 0, 1, 12],
        [30, 4, 91, 254, 0, 2, 4],
        [28, 2, 84, 254, 0, 2, 2],
        [25, 6, 72, 253, 1, 0, 7],
        [29, 14, 86, 253, 1, 4, 2],
        [32, 22, 76, 253, 1, 0, 14],
        [33, 36, 99, 253, 1, 4, 4],
        [26, 23, 67, 253, 1, 0, 15],
        [21, 8, 78, 253, 2, 0, 16],
        [29, 33, 121, 253, 2, 0, 20],
        [0, 28, 114, 253, 2, 0, 6],
        [28, 30, 105, 253, 3, 0, 24],
        [21, 20, 122, 253, 3, 0, 40],
        [21, 28, 127, 253, 4, 0, 29],
        [21, 33, 129, 253, 4, 0, 30],
        [20, 27, 105, 253, 5, 0, 31],
        [20, 30, 111, 253, 5, 0, 32],
        [12, 8, 112, 253, 6, 0, 33],
        [0, 10, 127, 253, 6, 0, 37],
        [0, 32, 119, 253, 7, 0, 43],
        [0, 11, 89, 253, 8, 0, 49],
        [0, 25, 108, 253, 8, 0, 50],
        [0, 12, 113, 253, 8, 0, 52],
        [0, 23, 105, 253, 9, 0, 54],
        [0, 13, 94, 253, 9, 0, 55],
        [21, 29, 103, 254, 5, 114, 1],
        [25, 30, 97, 253, 5, 0, 34],
        [0, 31, 108, 253, 2, 112, 1],
        [0, 15, 110, 253, 9, 112, 2],
        [0, 27, 111, 253, 10, 112, 3],
        [0, 17, 96, 253, 10, 112, 4],
        [0, 25, 109, 253, 6, 0, 39],
        [0, 11, 112, 253, 11, 0, 59],
        [0, 23, 95, 253, 5, 0, 60],
        [0, 19, 93, 253, 17, 0, 61],
        [0, 21, 114, 254, 2, 114, 2],
        [0, 33, 103, 254, 11, 1, 1],
        [0, 28, 107, 254, 20, 113, 1],
        [0, 13, 105, 253, 21, 112, 5],
        [0, 26, 92, 254, 22, 1, 2],
        [0, 10, 109, 253, 23, 112, 6],
        [0, 29, 101, 254, 24, 1, 3],
        [0, 35, 106, 254, 26, 1, 4],
        [0, 27, 95, 253, 28, 0, 38],
        [0, 15, 99, 254, 30, 0, 36],
        [38, 30, 101, 253, 2, 0, 35],
        [21, 22, 118, 253, 3, 0, 28],
        [12, 8, 106, 253, 3, 0, 25],
        [20, 13, 112, 253, 3, 0, 23],
        [21, 14, 104, 253, 3, 0, 17],
        [20, 28, 185, 253, 6, 4, 8],
        [15, 3, 108, 253, 6, 4, 10],
        [21, 3, 94, 253, 4, 4, 3],
        [20, 3, 102, 253, 4, 4, 5],
        [19, 2, 98, 253, 4, 4, 6],
    ].map((vs, i) => {
        let u = {
            PLAYER: i < 54 ? 0: 1,
            X: vs[0], Y: vs[1],
            MSTRNG: vs[2], CSTRNG: vs[2],
            ICON: vs[3],
            ARRIVE: vs[4],
            TYP: vs[5],
            ID: vs[6],
        }
        u.LABEL = [
            u.ID,
            ['', 'SS', 'FINNISH', 'RUMANIAN', 'ITALIAN', 'HUNGARAN', 'MOUNTAIN', 'GUARDS']
            [u.TYP >> 4],
            ['INFANTRY', 'TANK', 'CAVALRY', 'PANZER', 'MILITIA', 'SHOCK', 'PARATRP', 'PZRGRNDR']
            [u.TYP & 0x0f],
            ['CORPS', 'ARMY'][u.PLAYER]
        ].filter(Boolean).join(' ').trim();
        return u;
    });
    </script>

    <div id="screen">
        <div id="date-window" class="section"></div>
        <div class="date-rule rule section"></div>
        <div id="map-window" class="section">
            <div id="map">
                <div id="terrain"></div>
                <div id="unit-overlay"></div>
            </div>
        </div>
        <div class="info-rule rule section"></div>
        <div id="info-window" class="section"></div>
        <div class="err-rule rule section"></div>
        <div id="err-window" class="section"></div>
        <div class="err-rule rule section"></div>
        </div>
    </div>

    <script type="text/javascript">
function hexcolor(v) {
    if (typeof v === 'string') v = parseInt(v, 16);
    return colormap[Math.floor(v/2)];
}

function atasciichrclr(c) {
    let x = c.charCodeAt(0) % 128,
        chr = (x >= 32 && x < 96) ? x - 32 : (x < 32 ? x + 48: x),
        clr = 0; //TODO
    return [chr, clr];
}

function putchrs(win, data, chrclr, idfn, rowcol) {
    if (!chrclr) chrclr = atasciichrclr;
    if (!idfn) idfn = (d, i) => i;

    let rowidx = (d, i) => rowcol ? rowcol(d[0], i)[0] : i,
        lines = rowcol ? data.map(d => [d]): data,
        rows = d3.select(win)
        .selectAll('div.row')
        .data(lines, d => idfn(d[0]))
      .join('div')
        .attr('class', 'row')
        .attr('data-row-index', rowidx);

    if (rowcol) {
        rows.classed('row-abs', true)
            .each(function(d, i) {
                let [row, col] = rowcol(d[0], i);
                d3.select(this)
                    .style('right', `${col*8}px`)
                    .style('bottom', `${row*8}px`)
            })
    }
    rows.selectAll('div.chr')
        .data(d => d)
      .join('div')
        .datum(chrclr)
        .attr('class', ([_, clr]) => 'chr fgclr-' + clr)
        .style("-webkit-mask-position", ([chr, _]) => `${-(chr%16)*8}px ${-Math.floor(chr/16)*8}px`)
        ;
}


putchrs('#date-window', ['June 22, 1941'])
putchrs('#info-window', ['EASTERN FRONT 1941', 'COPYRIGHT 1981 CHRIS CRAWFORD'])
putchrs('#err-window', ['PLEASE ENTER YOUR ORDERS NOW'])

function mapchrclr(d) {
    const c = fontmap.indexOf(d),
        clr = c >> 6,
        chr = (c & 0x3f) + 0x40 * (this.parentNode.dataset.rowIndex <= 24 ? 2: 3);
    return [chr, clr];
}
putchrs('#terrain', mapdata, mapchrclr);


putchrs(
    '#unit-overlay',
    oob.filter(u => u.ARRIVE == 0),
    u => [u.ICON & 0x3f | 0x80, u.ICON >> 6],
    u => u.LABEL,
    u => [u.Y, u.X]
);


//TODO - debug colors
let colors = ['B0', '6A', '0C', '94', '46', '1A', '28', '22', '8A', '00', '3A', 'D4'];
d3.select('#screen')
    .append('div')
    .selectAll('span')
    .data(colors)
  .join('span')
    .style('background-color', hexcolor)
    .style('color', '#666')
    .text(d => d);

/*
Colors PDF p67

Section         BK      0       1       2       3
vert blank      B0      6A      OC      94      46
date window     1A      TRCOLR
date hrule      EARTH
map north               28
unit hrule                              22
unit info       8A
err hrule                       00      3A
err message     D4
*/

// tree color by month EFT18D.ASM
// TRTAB    0,$12,$12,$12,$D2,$D8,$D6,$C4,$D4,$C2,$12,$12,$12

// in some character modes COL2 is the background instead of COLBK

d3.selectAll('#unit-overlay .row').classed('blink', true);

var map = d3.select('#map')

map.selectAll('.row').style('background-color', hexcolor('02'));
map.selectAll('.fgclr-0').style('background-color', hexcolor('D6'));
map.selectAll('.row:nth-child(n+25) .fgclr-0').style('background-color', hexcolor('28'));
map.selectAll('.fgclr-1').style('background-color', hexcolor('0C'));
map.selectAll('.fgclr-2').style('background-color', hexcolor('94'));
map.selectAll('.fgclr-3').style('background-color', hexcolor('46'));

// TODO map south should have fgclr-0 => 28

d3.selectAll('#date-window .row').style('background-color', hexcolor('B0'));
d3.selectAll('#date-window .fgclr-0').style('background-color', hexcolor('6A'));
d3.selectAll('.date-rule').style('background-color', hexcolor('1A'));

d3.selectAll('.info-rule').style('background-color', hexcolor('02'));  // same as map
d3.selectAll('#info-window .row').style('background-color', hexcolor('22'));
d3.selectAll('#info-window .fgclr-0').style('background-color', hexcolor('28'));
d3.selectAll('#info-window .fgclr-2').style('background-color', hexcolor('28'));

d3.selectAll('.err-rule').style('background-color', hexcolor('8A'));
d3.selectAll('#err-window .row').style('background-color', hexcolor('3A'));
d3.selectAll('#err-window .fgclr-1').style('background-color', hexcolor('00'));
d3.selectAll('#err-window .fgclr-2').style('background-color', hexcolor('3A'));

        </script>
    </body>
</html>
