<html>
<head>
    <title>Chris Crawford's Eastern Front 1941</title>
    <link rel="icon" href="/static/AtariFuji.png">
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <script src="https://unpkg.com/d3@7.6.1/dist/d3.min.js"></script>
    <script src="/static/data.js"></script>

    <div id="screen">
        <div id="date-window" class="section"></div>
        <div class="date-rule rule section"></div>
        <div id="map-window" class="section">
            <div id="map">
                <div id="terrain"></div>
                <div id="label-overlay"></div>
                <div id="unit-overlay"></div>
                <div id="kreuze-overlay"></div>
            </div>
        </div>
        <div class="info-rule rule section"></div>
        <div id="info-window" class="section"></div>
        <div class="err-rule rule section"></div>
        <div id="err-window" class="section"></div>
        <div class="err-rule rule section"></div>
        </div>
    </div>

    <script type="text/javascript">
function hexcolor(v) {
    return colormap[Math.floor(parseInt(v, 16)/2)];
}

function setclr(sel, c) {
    d3.selectAll(sel).style('background-color', hexcolor(c));
}

function atascii(c) {
    let x = c.charCodeAt(0) % 128;
    return (x >= 32 && x < 96) ? x - 32 : (x < 32 ? x + 48: x);
}

function putchrs(win, data, fg, bg, chrfn, idfn, rowcol) {
    if (!chrfn) chrfn = atascii;
    if (!idfn) idfn = (d, i) => i;
    fgfn = typeof fg == 'function' ? fg : (_ => fg);
    bgfn = typeof bg == 'function' ? bg : (_ => bg);

    let rowidx = (d, i) => rowcol ? rowcol(d[0], i)[0] : i,
        lines = rowcol ? data.map(d => [d]): data,
        rows = d3.select(win)
        .selectAll('div.row')
        .data(lines, d => idfn(d[0]))
      .join('div')
        .attr('class', 'row')
        .attr('data-row-index', rowidx)
        .style('background-color', d => hexcolor(bgfn(d)));

    if (rowcol) {
        rows.classed('row-abs', true)
            .each(function(d, i) {
                let [row, col] = rowcol(d[0], i);
                d3.select(this)
                    .style('right', `${col*8}px`)
                    .style('bottom', `${row*8}px`)
            })
    }
    return rows.selectAll('div.chr')
        .data(d => d)
      .join('div')
        .classed('chr', true)
        .style('background-color', d => hexcolor(fgfn(d)))
        .style("-webkit-mask-position", d => {
            let c = chrfn(d);
            return `${-(c%16)*8}px ${-Math.floor(c/16)*8}px`
        });
}

var turninfo = {
    turn: 0,
    icelat: 39,
}

function nextturn() {
    turninfo.turn++;

    let dt = new Date('1941/06/15');
    dt.setDate(dt.getDate() + 7*turninfo.turn);

    let label = dt.toLocaleDateString("en-US", { year: 'numeric', month: 'long', day: 'numeric' });
        minfo = monthdata[dt.getMonth()],  // note 0-indexed
        earth = weatherdata[minfo.weather].earth,
        trees = minfo.trees;

    putchrs('#date-window', [label], '6A', 'B0')
    //TODO use setclr ?
    d3.selectAll('#terrain .chr').filter(d => d.terrain == Terrain.mountain_forest && d.alt == 1)
        .style('background-color', hexcolor(trees));
    //TODO hexcolor?
    d3.selectAll('#label-overlay .label').style('color', minfo.weather == Weather.snow ? '#333': '#ccc');
    setclr('#terrain .row, #unit-overlay .row', earth);

    if (minfo.rivers) {
        // => thaw swamp/rivers
        // ICELAT -= [7,14] incl]; clamp 1-39 incl
        // small bug? freeze chrs $0B - $29 (exclusive, seems like it could freeze Kerch straight?)

        let oldlat = turninfo.icelat,
            change = Math.floor(Math.random()*8) + 7,
            dir = minfo.rivers == 'freeze' ? -1 : +1;
        turninfo.icelat = Math.max(1, Math.min(39, turninfo.icelat + dir * change));

        //TODO update terrain type and color between oldlat/icelat
        // unfreeze as well as freeze...
        d3.selectAll('#terrain .chr')
            .filter(d => d.y >= turninfo.icelat && (d.terrain == Terrain.river || d.terrain == Terrain.swamp))
            .style('background-color', hexcolor('0C'));
    }

    console.log(JSON.stringify(turninfo));
}

setclr('body', 'D4');
setclr('.date-rule', '1A');
setclr('.info-rule', '02');  // same as map
setclr('.err-rule', '8A');

putchrs('#info-window', ['EASTERN FRONT 1941', 'COPYRIGHT 1981 CHRIS CRAWFORD'], '28', '22')
putchrs('#err-window', ['PLEASE ENTER YOUR ORDERS NOW'], '22', '3A')

putchrs(
    '#terrain',
    mapdata,
    d => {
        let ter = terraintypes[d.terrain];
        return d.alt ? ter.altcolor : ter.color
    },
    '02',
    d => d.icon
).attr('title', JSON.stringify);

d3.select('#label-overlay')
    .selectAll('div.label')
    .data(cities)
  .join('div')
    .classed('label', true)
    .text(d => d.label)
    .style('right', d => `${d.x * 8 + 4}px`)
    .style('bottom', d => `${d.y * 8 + 10}px`)
    ;

nextturn();

var target = {x: 0, y: 0};

function showtarget(x, y) {
    target.x = x;
    target.y = y;
    d3.select('#kreuze-overlay').style('visibility', 'visible');
    putchrs('#kreuze-overlay', [target], '1A', '02', _ => 256, _ => 0, d => [d.y, d.x]);
    centertarget();
}

function centertarget() {
    d3.select('#kreuze-overlay .chr').node().scrollIntoView({block: "center", inline: "center"});
}

function hidetarget() {
    d3.select('#kreuze-overlay').style('visibility', 'hidden');
    d3.select('.blink').classed('blink', false);
}

// d3.select('#map .row:nth-child(19) .chr:nth-child(26)').style('background-color', 'yellow').node().scrollIntoView({block: "center", inline: "center"});

function selectunit(u) {
    console.log(current);
    hidetarget();
    showtarget(u.x, u.y);
    d3.selectAll('#unit-overlay .chr')
        .filter(d => d.id == u.id)
        .each(function() {
            d3.select(this.parentNode).classed('blink', true);
        });
}

function unitclick(ev, u) {
    putchrs('#info-window', [u.label, ' '], '28', '22')
    console.log(JSON.stringify(u))
    if (u.player == 0) {
        current = german.findIndex(d => d.id == u.id);
        selectunit(u);
    } else {
        hidetarget();
    }
}

function niceorder(units) {
    return units.sort((a, b) => ((a.y - b.y) << 8) + (a.x - b.x));
}

var active = oob.filter(u => u.arrive == 0),
    german = niceorder(active.filter(u => u.player == 0)),
    current = null;

putchrs(
    '#unit-overlay',
    active,
    u => u.player ? '46' : '0C',
    '02',
    u => u.icon,
    u => u.id,
    u => [u.y, u.x]
).on('click', unitclick);


/* debug blocked sides */
/*
putchrs(
    '#label-overlay',
    blocked[0].map(d => [d.y+0.5, d.x]).concat(blocked[1].map(d => [d.y, d.x+0.5])),
    '6A', '02',
    d => Math.floor(d[0]) != d[0] ? 82 : 124,
    (d, i) => i,
    d => d
);
*/

function stepdir(x, y, dir) {
    let {x: dx, y: dy} = directions[dir],
        x2 = x + dx,
        y2 = y + dy,
        legal = (
            mapdata[39 - y2][46 - x2].terrain != Terrain.impassable
            && !(
                (dir == Direction.north || dir == Direction.south)
                ? blocked[0].find(d => d.x == x && d.y == (dir == Direction.north ? y : y2))
                : blocked[1].find(d => d.x == (dir == Direction.west ? x : x2) && d.y == y)
            ));
    return legal ? [x2, y2]: [x, y];
}

var zoom = 1;
document.addEventListener('keydown', function (e) {
    console.log(e.key);
    switch (e.key) {
        case 'z':
            zoom = zoom == 1 ? 2: 1;
            d3.select('#map').style('transform', `scale(${zoom})`);
            centertarget();
            break;
        //TODO 'x' toggle extras like labels
        case 'n':
            current = current === null ? 0 : ((current + 1) % german.length);
            selectunit(german[current]);
            break;
        case 'p':
            current = (current + german.length - 1) % german.length;
            selectunit(german[current]);
            break;


        case 'Enter':
            nextturn();
            break;
        case 'ArrowUp':
            showtarget(...stepdir(target.x, target.y, Direction.north));
            break;
        case 'ArrowRight':
            showtarget(...stepdir(target.x, target.y, Direction.east));
            break;
        case 'ArrowDown':
            showtarget(...stepdir(target.x, target.y, Direction.south));
            break;
        case 'ArrowLeft':
            showtarget(...stepdir(target.x, target.y, Direction.west));
            break;
        default:
            console.log(`Ignoring ${e.key}`)
            return;
    }
    e.preventDefault();
});


//TODO - debug colors
// let colors = ['B0', '6A', '0C', '94', '46', '1A', '28', '22', '8A', '00', '3A', 'D4'];
let colors = ['58','DC','2F','00','6A','0C','94','46','B0'];  // COLTAB

d3.select('#screen')
    .append('div')
    .selectAll('span')
    .data(colors)
  .join('span')
    .style('background-color', hexcolor)
    .style('color', '#666')
    .text(d => d);

/*
Colors PDF p67

M.ASM
8620 COLTAB .BYTE $58,$DC,$2F,0,$6A,$C,$94,$46,$B0


Section         BK      0       1       2       3
vert blank      B0      6A      OC      94      46
date window     1A      TRCOLR
date hrule      EARTH
map north               28
unit hrule                              22
unit info       8A
err hrule                       00      3A
err message     D4
*/

// in some character modes COL2 is the background instead of COLBK


    </script>
</body>
</html>
